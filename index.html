<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="css/sliderStyle.css">
    <link rel="stylesheet" href="css/button.css">
    <link rel="stylesheet" href="css/selection.css">
    <title>Ecosystem Simulation</title>
</head>
<!--Load the AJAX API-->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">

</script>

<body style="margin: 0; overflow: hidden">
<script src="js/util/loadData.js" type="module"></script>
<script src="/js/app.js"></script>
<script type="module" src="/js/threeStarter.js"></script>
<script src="js/util/perlinNoise.js"></script>
<script type= "module" src="js/util/domElementHandlers.js"></script>
<script src="js/util/chartDrawer.js"></script>
<script src="js/util/AStar.js" type="module"></script>
<script src="js/parameters.js"></script>
<script src="js/library/dat.gui.min.js"></script>
<script src="js/gui/gui.js"></script>
<script src="js/world/World.js" type="module"></script>
<script src="js/world/Grid.js" type="module"></script>
<script src="js/mouse/drawerHandler.js" type="module"></script>
<script src="js/mouse/mouse_picking.js" type="module"></script>
<script src="js/world/ObjectBases.js" type="module"></script>
<script src="js/world/Objects.js" type="module"></script>
<script src="js/world/Materials.js" type="module"></script>
<script id="vertexShader" type="x-shader/x-vertex" src="shader.vert">
    attribute vec4 tangent;

    varying vec3 yeNormal;
    varying vec3 yeTangent;

    varying vec2 vUv;
    varying vec3 vNormal;
    varying vec3 vPosition;
    varying vec3 vTangent;

    varying vec3 worldPosition;
    varying mat3 TBN;
    void main() {
        vUv = uv;
        // TODO DELETE
        yeNormal = normal;
        yeTangent = tangent.xyz;

        worldPosition = (modelMatrix * vec4(position, 1.0)).xyz;

        vNormal = (modelViewMatrix * vec4(normal, 0.0)).xyz;
        vPosition = (modelViewMatrix * vec4(position, 1.0)).xyz;

        // Normal Mapping
        vTangent = tangent.xyz;
        vec3 vBitangent = cross(normal, vTangent);
        TBN = mat3(modelViewMatrix * mat4(mat3(vTangent, vBitangent, normal)));

        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
</script>
<script id="fragmentShader" type="x-shader/x-fragment">
    struct PointLight {
        vec3 color;
        vec3 position;
        float distance;
    };
    uniform PointLight pointLights[NUM_POINT_LIGHTS];

    varying vec3 vNormal;
    varying vec3 vPosition;
    uniform vec3 color;
    varying vec2 vUv;
    void main() {

        vec4 addedLights = vec4(0.0,
        0.0,
        0.0,
        1.0);
        for (int l = 0; l < NUM_POINT_LIGHTS; l++) {
            vec3 distanceVec = vPosition - pointLights[l].position;
            vec3 lightDirection = normalize(distanceVec);
            float attuanation = 0.0;
            if(float(pointLights[l].distance) >= length(distanceVec)){
                attuanation = pow((1.0 - (length(distanceVec) / float(pointLights[l].distance))), 2.0);
            }

            addedLights.rgb += clamp(dot(-lightDirection, vNormal), 0.0, 1.0) * (pointLights[l].color * attuanation);
        }
        addedLights = max(vec4(0.3), addedLights);
        addedLights = min(vec4(1.5), addedLights);

        gl_FragColor = vec4(color, 1.)*addedLights;
    }
</script>
<script id="terrainFragmentShader" type="x-shader/x-fragment">
    precision mediump float;

    struct PointLight {
        vec3 color;
        vec3 position;
        float distance;
    };
    uniform PointLight pointLights[NUM_POINT_LIGHTS];

    varying vec3 yeNormal;
    varying vec3 yeTangent;

    varying vec3 vNormal;
    varying vec3 vPosition;
    uniform vec3 color;
    varying vec2 vUv;
    varying vec3 vTangent;

    varying vec3 worldPosition;
    varying mat3 TBN;

    uniform float repeatFactor;
    uniform sampler2D groundNormalMap;
    uniform sampler2D snowNormalMap;
    uniform sampler2D perlinMap;
    uniform float maxTerrainHeight;

    float rand(vec2 co) {
        return fract(sin(dot(co, vec2(12.9898, 78.233))) * 43758.5453);
    }

    void main() {
        int terrainType;
        vec3 terrainColor;
        float height = float(worldPosition.y) / float(maxTerrainHeight);
        float heightWithRand = height - length(texture2D(perlinMap, vUv * 10.0).xyz) / 25.0;
        if (height < -0.34) { // Water
            terrainColor = vec3(0.00000000000, 0.18431372549, 0.65490196078);
            terrainType = 0;
        } else if (heightWithRand < -0.32) { // Beach
            terrainColor = vec3(0.72156862745, 0.66274509804, 0.47450980392);
            terrainType = 1;
        } else if (heightWithRand < 0.35) { // Ground
            float perlin = texture2D(perlinMap, vUv).r;
            // float perlintwox = texture2D(perlinMap, vUv * 2.0).r;
            // float perlinthreex = texture2D(perlinMap, vUv * 3.0).r;
            if(perlin > 0.25) { // Grass
                terrainColor = vec3(0.06666666667, 0.48627450980, 0.07450980392);
            } else { // Dirt
                terrainColor = vec3(0.42745098039, 0.31372549020, 0.24705882353);
            }
            terrainType = 2;
        } else { // Snow
            terrainColor = vec3(0.87450980392, 0.90980392157, 0.94117647059);
            terrainType = 3;
        }

        // norm = normalize(norm * 2.0 - 1.0);

        vec3 norm;
        /*if (terrainType == 3) {
            norm = texture2D(snowNormalMap, vUv * 5.0).rgb;
        } else {
            norm = texture2D(groundNormalMap, vUv * repeatFactor).rgb;
        }*/

        norm = texture2D(groundNormalMap, vUv * repeatFactor).rgb;
        norm = vec3(1.0 - norm.r, 1.0 - norm.g, norm.b);
        norm = norm * 2.0 - 1.0;
        norm = normalize(TBN * norm);

        // TODO Normal mapping hala ışığın tam tersine bakarken yanıyor gibi, neden olduğunu anla.

        vec4 addedLights = vec4(0.0,
        0.0,
        0.0,
        1.0);
        for (int l = 0; l < NUM_POINT_LIGHTS; l++) {
            vec3 distanceVec = vPosition - pointLights[l].position;
            distanceVec = distanceVec * 2.0;
            float lightDistance = float(pointLights[l].distance);
            vec3 lightDirection = normalize(distanceVec);
            float attuanation = 0.0;
            if(lightDistance >= length(distanceVec)){
                attuanation = pow((1.0 - (length(distanceVec) / lightDistance)), 2.0);
            }

            if (terrainType != 0) {
                addedLights.rgb += clamp(dot(-lightDirection, norm), 0.0, 1.0) * (pointLights[l].color * attuanation);
            } else {
                addedLights.rgb += clamp(dot(-lightDirection, vNormal), 0.0, 1.0) * (pointLights[l].color * attuanation);
            }
        }
        addedLights = max(vec4(0.3), addedLights);
        addedLights = min(vec4(1.5), addedLights);

        // gl_FragColor = vec4(yeTangent, 1.) * addedLights;
        gl_FragColor = vec4(terrainColor, 1.) * addedLights;
        // gl_FragColor = vec4(norm, 1.);
        // gl_FragColor = vec4(worldPosition.y, worldPosition.y, worldPosition.y, 1.) * addedLights;
    }
</script>
<div id="holder" style="display: flex; background-color: black; flex-direction: row; justify-content: flex-end;">
    <div style="background-color: black" id="leftBar">
        <div style="background-color: black" id="chartHolder">
        </div>
        <div>
            <div style="text-align: center; padding: 10px">
                <div style="font-size: 18pt; color: aliceblue">Timescale</div>
                <input onchange="simulationSpeedChange()" style="width: 100%;" type="range" min="0.1" max="200"
                       value="20" step="0.1" class="slider" id="timescale-slider">
            </div>
            <div style="text-align: center; padding: 10px">
                <button onclick="simulationToggle()" class="button" style="font-size: 20pt" id="stop-sim-button">Pause
                    Simulation
                </button>
            </div>
        </div>
    </div>

    <div style="background-color: black" id="midBar"></div>

    <div style="background-color: black; width: 320px; margin-top: 200px" id="rightBar">
        <div style="text-align: center; margin: 15px">
            <input type="checkbox" id="brush"><label style="color: white" for="brush">Brush</label>
            <input type="checkbox" id="eraser"><label style="color: white" for="eraser">Eraser</label>
        </div>
        <select name="brushElements" id="brushElements" class="list-choice" style="width: 100%">
            <option value="human">Human</option>
            <option value="wall">Wall</option>
            <option value="squirrel">Squirrel</option>
            <option value="tree">Tree</option>
        </select>

        <button id='saveButton' class="btn" style="font-size: 14pt"><i class="fa fa-download"></i> Save Template</button>
        <input id='fileid' type='file' hidden/>
        <input id='loadButton' type='button' value='Load Template'  style="font-size : 19px" />

    </div>
</div>
</body>
</html>